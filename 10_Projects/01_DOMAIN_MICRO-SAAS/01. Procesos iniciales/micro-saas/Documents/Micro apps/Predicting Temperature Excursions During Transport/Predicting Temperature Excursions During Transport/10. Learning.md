##### Procede con todo

Â¡Hecho, Armando! ProcedÃ­ **con todo**: dejÃ© listos los **DDL SQL**, el **diseÃ±o de la tabla KPI estÃ¡ndar**, un **slide (PNG)** para tu presentaciÃ³n, y el **backend sugerido** (ETL + endpoints REST) para que cualquier dashboard consuma un **formato Ãºnico**. Abajo te explico y te dejo **todo el cÃ³digo** listo para usar.

---

## ğŸ“¦ Entregables generados ahora

1. **DDL de tablas (SQL Server)**
    
    - `artifacts/sql/KPI_Facts.sql`
    - `artifacts/sql/KPI_Series.sql`
2. **Diapositiva comercial (PNG)**
    
    - `artifacts/KPI_Standard_Slide.png`\ _TÃ­tulo:_ â€œKPI EstÃ¡ndar: Una sola fuente para todos los dashboardsâ€\ _Contenido:_ flujo â€œDefiniciÃ³n KPIs â†’ Tabla EstÃ¡ndar â†’ API REST â†’ Consumo Multiplataformaâ€

> Si quieres, puedo crear tambiÃ©n **SVG** y/o una **presentaciÃ³n .pptx** con esta diapositiva incluida.

---

## ğŸ—ƒï¸ Esquema de datos (recordatorio)

### `KPI_Facts`

- **Claves principales**: `KPI_Name`, `Period_Start/End`, `Granularity`, `Breakdown_Dimension/Value`
- **Trazabilidad**: `Model_Version`, `Threshold_Used`, `Last_Updated`
- **Unidades**: `KPI_Unit` (`%`, `count`, `EUR`)

### `KPI_Series`

- Series temporales (p. ej., tendencia de excursiones por mes/semana) con `Series_Timestamp` y desglose opcional.

> Los DDL estÃ¡n ya en `artifacts/sql/â€¦` para ejecutar directamente.

---

## ğŸ› ï¸ ETL / CÃ¡lculo de KPIs

Puedes implementar el cÃ¡lculo de KPIs con:

- **SQL puro (stored procedures)** o
- **.NET Worker** (calcula y hace _upsert_).

Te propongo **procedimientos almacenados** para _upserts_ y un **Worker .NET** que los invoque. AsÃ­ el cÃ¡lculo puede crecer sin rehacer la API.

### A) Stored Procedures (ejemplos)

> **1) Upsert para `KPI_Facts`** (guÃ¡rdalo como `dbo.usp_KPIFacts_Upsert.sql`)

CREATE OR ALTER PROCEDURE dbo.usp_KPIFacts_Upsert

(

Â Â Â  @KPI_Name_Â Â Â Â Â Â Â Â Â Â Â  _nvarchar(100),_

Â Â Â  _@KPI_DisplayNameÂ Â Â Â  nvarchar(200),

Â Â Â  @KPI_Value_Â Â Â Â Â Â Â Â Â Â  _decimal(18,4),_

Â Â Â  _@KPI_UnitÂ Â Â Â Â Â Â Â Â Â Â  nvarchar(50),

Â Â Â  @Period_Start_Â Â Â Â Â Â Â  _datetime2,_

Â Â Â  _@Period_EndÂ Â Â Â Â Â Â Â Â  datetime2,

Â Â Â  @GranularityÂ Â Â Â Â Â Â Â  nvarchar(20),

Â Â Â  @Breakdown_Dimension_ _nvarchar(50) = NULL,_

Â Â Â  _@Breakdown_ValueÂ Â Â Â  nvarchar(200) = NULL,

Â Â Â  @Model_Version_Â Â Â Â Â Â  _nvarchar(100) = NULL,_

Â Â Â  _@Threshold_UsedÂ Â Â Â Â  decimal(9,4) = NULL,

Â Â Â  @NotesÂ Â Â Â Â Â Â Â Â Â Â Â Â Â  nvarchar(500) = NULL

)

AS

BEGIN

Â Â Â  SET NOCOUNT ON;

  

Â Â Â  MERGE dbo.KPI_Facts_ _AS T_

Â Â Â  _USING (SELECT @KPI_Name AS KPI_Name__,_

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  _@KPI_DisplayName AS KPI_DisplayName__,_

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  _@KPI_Value AS KPI_Value__,_

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  _@KPI_Unit AS KPI_Unit__,_

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  _@Period_Start AS Period_Start__,_

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  _@Period_End AS Period_End__,_

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  _@Granularity AS Granularity,_

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  _@Breakdown_Dimension AS Breakdown_Dimension__,_

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  _@Breakdown_Value AS Breakdown_Value__,_

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  _@Model_Version AS Model_Version__,_

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  _@Threshold_Used AS Threshold_Used__,_

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  _@Notes AS Notes) AS S_

Â Â Â  _ONÂ  T.KPI_Name = S.KPIÂ¨C113CStart = S.PeriodÂ¨C114CEndÂ Â  = S.PeriodÂ¨C115CDimension,'') = ISNULL(S.BreakdownÂ¨C116CValue,'')Â Â Â  = ISNULL(S.BreakdownÂ¨C117CDisplayName = S.KPIÂ¨C118CValue = S.KPIÂ¨C119CUnit = S.KPIÂ¨C120CVersion = S.ModelÂ¨C121CVersion = S.ModelÂ¨C122CUsed = S.ThresholdÂ¨C123CUpdated = SYSUTCDATETIME(),

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Notes = S.Notes

Â Â Â  WHEN NOT MATCHED THEN

Â Â Â Â Â Â Â  INSERT (KPI_Name__, KPI_DisplayName, KPI_Value__, KPI_Unit, Period_Start__, Period_End,

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Granularity, Breakdown_Dimension__, Breakdown_Value, Model_Version__, Threshold_Used, Last_Updated__, Notes)_

Â Â Â Â Â Â Â  _VALUES (S.KPI_Name, S.KPI_DisplayName__, S.KPI_Value, S.KPI_Unit__, S.Period_Start, S.Period_End__,_

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  _S.Granularity, S.Breakdown_Dimension, S.Breakdown_Value__, S.Model_Version, S.Threshold_Used, SYSUTCDATETIME(), S.Notes);

> **2) Upsert para `KPI_Series`** (guÃ¡rdalo como `dbo.usp_KPISeries_Upsert.sql`)

CREATE OR ALTER PROCEDURE dbo.usp_KPISeries_Upsert

(

Â Â Â  @KPI_Name_Â Â Â Â Â Â Â Â Â Â Â  _nvarchar(100),_

Â Â Â  _@Series_TimestampÂ Â Â  datetime2,

Â Â Â  @Series_Value_Â Â Â Â Â Â Â  _decimal(18,4),_

Â Â Â  _@Breakdown_Dimension nvarchar(50) = NULL,

Â Â Â  @Breakdown_Value_Â Â Â Â  _nvarchar(200) = NULL,_

Â Â Â  _@Model_VersionÂ Â Â Â Â Â  nvarchar(100) = NULL

)

AS

BEGIN

Â Â Â  SET NOCOUNT ON;

  

Â Â Â  MERGE dbo.KPI_Series_ _AS T_

Â Â Â  _USING (SELECT @KPI_Name AS KPI_Name__,_

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  _@Series_Timestamp AS Series_Timestamp__,_

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  _@Series_Value AS Series_Value__,_

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  _@Breakdown_Dimension AS Breakdown_Dimension__,_

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  _@Breakdown_Value AS Breakdown_Value__,_

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  _@Model_Version AS Model_Version__) AS S_

Â Â Â  _ONÂ  T.KPI_Name = S.KPI_Name_

Â Â Â  _AND T.Series_Timestamp = S.Series_Timestamp_

Â Â Â Â Â Â  _AND ISNULL(T.Breakdown_Dimension,'') = ISNULL(S.Breakdown_Dimension__,'')_

Â Â Â  _AND ISNULL(T.Breakdown_Value,'')Â Â Â  = ISNULL(S.Breakdown_Value__,'')_

Â Â Â  _WHEN MATCHED THEN_

Â Â Â Â Â Â Â  _UPDATE SET Series_Value = S.SeriesÂ¨C179CVersion = S.ModelÂ¨C180CUpdated = SYSUTCDATETIME()

Â Â Â  WHEN NOT MATCHED THEN

Â Â Â Â Â Â Â  INSERT (KPI_Name__, Series_Timestamp, Series_Value__, Breakdown_Dimension, Breakdown_Value__, Model_Version, Last_Updated__)_

Â Â Â Â Â Â Â  _VALUES (S.KPI_Name, S.Series_Timestamp__, S.Series_Value, S.Breakdown_Dimension__, S.Breakdown_Value, S.Model_Version, SYSUTCDATETIME());

### B) .NET Worker (cÃ¡lculo y carga)

- **Supuesto**: tienes tabla `Predictions` con columnas mÃ­nimas:
    - `ShipmentId`, `ScoredAt`, `RiskProbability`, `RiskFlag`, `Temp_Excursion_True` (0/1), `Route_ID`, `Carrier`, `Packaging_Type`, `Model_Version`, `Threshold_Used`
- **KPIs ejemplo**:
    - `Risk_Percentage` (por periodo y desglose)
    - `Model_Recall`, `Model_Precision` (rolling 30d)
    - `Active_Alerts` (embarques en trÃ¡nsito con `RiskFlag=1`)
    - `Excursion_Trend_Index` (serie mensual)

// WorkerKpiLoader.cs (fragmento)

using System.Data;

using Microsoft.Data.SqlClient;

  

public class KpiJob

{

Â Â Â  private readonly string _conn__;_

Â Â Â  _public KpiJob(string conn) =>_ conn = conn;

  

Â Â Â  public async Task RunAsync(DateTime utcNow)

Â Â Â  {

Â Â Â Â Â Â Â  // Define periodo mensual y rolling 30 dÃ­as

Â Â Â Â Â Â Â  var periodStart = new DateTime(utcNow.Year, utcNow.Month, 1);

Â Â Â Â Â Â Â  var periodEnd = periodStart.AddMonths(1).AddTicks(-1);

Â Â Â Â Â Â Â  var rollingStart = utcNow.AddDays(-30);

  

Â Â Â Â Â Â Â  using var cn = new SqlConnection(_conn__);_

Â Â Â Â Â Â Â  _await cn.OpenAsync();_

Â Â Â Â Â Â Â  _// 1) Risk_Percentage por ruta (ejemplo de breakdown)

Â Â Â Â Â Â Â  var riskByRoute = await QueryAsync(cn, @"

Â Â Â Â Â Â Â Â Â Â Â  SELECT Route_ID AS Breakdown_Value,

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  CAST(SUM(CASE WHEN RiskFlag=1 THEN 1 ELSE 0 END)_100.0/COUNT(_) AS DECIMAL(18,4)) AS KPI_Value,_

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  _MAX(Model_Version) AS Model_Version,_

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  _MAX(Threshold_Used) AS Threshold_Used_

Â Â Â Â Â Â Â Â Â Â Â  _FROM dbo.Predictions_

Â Â Â Â Â Â Â Â Â Â Â  _WHERE ScoredAt BETWEEN @ps AND @pe_

Â Â Â Â Â Â Â Â Â Â Â  _GROUP BY Route_ID", new { ps = periodStart, pe = periodEnd });

  

Â Â Â Â Â Â Â  foreach (var row in riskByRoute)

Â Â Â Â Â Â Â  {

Â Â Â Â Â Â Â Â Â Â Â  await ExecAsync(cn, "dbo.usp_KPIFacts_Upsert", new {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  KPI_Name_ _= "Risk_Percentage",

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  KPI_DisplayName_ _= "Porcentaje de embarques en riesgo",_

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  _KPI_Value = row.KPI_Value__,_

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  _KPI_Unit = "%",

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Period_Start_ _= periodStart,_

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  _Period_End = periodEnd,

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Granularity = "monthly",

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Breakdown_Dimension_ _= "Route_ID",

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Breakdown_Value_ _= (string)row.Breakdown_Value,

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Model_Version_ _= (string)row.Model_Version,

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Threshold_Used_ _= (decimal)row.Threshold_Used,

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Notes = (string?)null

Â Â Â Â Â Â Â Â Â Â Â  });

Â Â Â Â Â Â Â  }

  

Â Â Â Â Â Â Â  // 2) MÃ©tricas del modelo (rolling 30 dÃ­as)

Â Â Â Â Â Â Â  var pr = await QuerySingleAsync(cn, @"

Â Â Â Â Â Â Â Â Â Â Â  WITH X AS (

Â Â Â Â Â Â Â Â Â Â Â Â Â  SELECT

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  CASE WHEN Temp_Excursion_True=1 AND RiskFlag=1 THEN 1 ELSE 0 END AS TP,

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  CASE WHEN Temp_Excursion_True=1 AND RiskFlag=0 THEN 1 ELSE 0 END AS FN,

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  CASE WHEN Temp_Excursion_True=0 AND RiskFlag=1 THEN 1 ELSE 0 END AS FP

Â Â Â Â Â Â Â Â Â Â Â Â Â  FROM dbo.Predictions

Â Â Â Â Â Â Â Â Â Â Â Â Â  WHERE ScoredAt >= @from

Â Â Â Â Â Â Â Â Â Â Â  )

Â Â Â Â Â Â Â Â Â Â Â  SELECT

Â Â Â Â Â Â Â Â Â Â Â Â Â  CAST(SUM(TP)_1.0/NULLIF(SUM(TP)+SUM(FN),0) AS DECIMAL(18,4)) AS Recall,_

Â Â Â Â Â Â Â Â Â Â Â Â Â  _CAST(SUM(TP)_1.0/NULLIF(SUM(TP)+SUM(FP),0) AS DECIMAL(18,4)) AS Precision,

Â Â Â Â Â Â Â Â Â Â Â Â Â  MAX(Model_Version) AS Model_Version,

Â Â Â Â Â Â Â Â Â Â Â Â Â  MAX(Threshold_Used) AS Threshold_Used

Â Â Â Â Â Â Â Â Â Â Â  FROM X", new { from = rollingStart });

  

Â Â Â Â Â Â Â  await ExecAsync(cn, "dbo.usp_KPIFacts_Upsert", new {

Â Â Â Â Â Â Â Â Â Â Â  KPI_Name_ _= "Model_Recall",

Â Â Â Â Â Â Â Â Â Â Â  KPI_DisplayName_ _= "Recall del modelo (30 dÃ­as)",_

Â Â Â Â Â Â Â Â Â Â Â  _KPI_Value = (decimal?)pr?.Recall ?? 0m,

Â Â Â Â Â Â Â Â Â Â Â  KPI_Unit_ _= "%",_

Â Â Â Â Â Â Â Â Â Â Â  _Period_Start = rollingStart,

Â Â Â Â Â Â Â Â Â Â Â  Period_End_ _= utcNow,_

Â Â Â Â Â Â Â Â Â Â Â  _Granularity = "rolling_30d",

Â Â Â Â Â Â Â Â Â Â Â  Breakdown_Dimension_ _= (string?)null,_

Â Â Â Â Â Â Â Â Â Â Â  _Breakdown_Value = (string?)null,

Â Â Â Â Â Â Â Â Â Â Â  Model_Version_ _= (string?)pr?.Model_Version ?? "n/a",

Â Â Â Â Â Â Â Â Â Â Â  Threshold_Used_ _= (decimal?)pr?.Threshold_Used ?? 0.35m,

Â Â Â Â Â Â Â Â Â Â Â  Notes = (string?)null

Â Â Â Â Â Â Â  });

  

Â Â Â Â Â Â Â  await ExecAsync(cn, "dbo.usp_KPIFacts_Upsert", new {

Â Â Â Â Â Â Â Â Â Â Â  KPI_Name_ _= "Model_Precision",

Â Â Â Â Â Â Â Â Â Â Â  KPI_DisplayName_ _= "PrecisiÃ³n del modelo (30 dÃ­as)",_

Â Â Â Â Â Â Â Â Â Â Â  _KPI_Value = (decimal?)pr?.Precision ?? 0m,

Â Â Â Â Â Â Â Â Â Â Â  KPI_Unit_ _= "%",_

Â Â Â Â Â Â Â Â Â Â Â  _Period_Start = rollingStart,

Â Â Â Â Â Â Â Â Â Â Â  Period_End_ _= utcNow,_

Â Â Â Â Â Â Â Â Â Â Â  _Granularity = "rolling_30d",

Â Â Â Â Â Â Â Â Â Â Â  Breakdown_Dimension_ _= (string?)null,_

Â Â Â Â Â Â Â Â Â Â Â  _Breakdown_Value = (string?)null,

Â Â Â Â Â Â Â Â Â Â Â  Model_Version_ _= (string?)pr?.Model_Version ?? "n/a",

Â Â Â Â Â Â Â Â Â Â Â  Threshold_Used_ _= (decimal?)pr?.Threshold_Used ?? 0.35m,

Â Â Â Â Â Â Â Â Â Â Â  Notes = (string?)null

Â Â Â Â Â Â Â  });

  

Â Â Â Â Â Â Â  // 3) Active_Alerts (en trÃ¡nsito)_

Â Â Â Â Â Â Â  _var activeAlerts = await QuerySingleScalarAsync<decimal>(cn, @"_

Â Â Â Â Â Â Â Â Â Â Â  _SELECT CAST(COUNT(_) AS DECIMAL(18,4))__

Â Â Â Â Â Â Â Â Â Â Â  __FROM dbo.Predictions__

Â Â Â Â Â Â Â Â Â Â Â  __WHERE InTransitFlag=1 AND RiskFlag=1 AND ScoredAt BETWEEN @ps AND @pe",__

Â Â Â Â Â Â Â Â Â Â Â  __new { ps = periodStart, pe = periodEnd });__

Â Â Â Â Â Â Â  __await ExecAsync(cn, "dbo.usp_KPIFacts_Upsert", new {_

Â Â Â Â Â Â Â Â Â Â Â  _KPI_Name = "Active_Alerts"__,_

Â Â Â Â Â Â Â Â Â Â Â  _KPI_DisplayName = "Alertas activas (en trÃ¡nsito)",

Â Â Â Â Â Â Â Â Â Â Â  KPI_Value_ _= activeAlerts,_

Â Â Â Â Â Â Â Â Â Â Â  _KPI_Unit = "count",

Â Â Â Â Â Â Â Â Â Â Â  Period_Start_ _= periodStart,_

Â Â Â Â Â Â Â Â Â Â Â  _Period_End = periodEnd,

Â Â Â Â Â Â Â Â Â Â Â  Granularity = "monthly",

Â Â Â Â Â Â Â Â Â Â Â  Breakdown_Dimension_ _= (string?)null,_

Â Â Â Â Â Â Â Â Â Â Â  _Breakdown_Value = (string?)null,

Â Â Â Â Â Â Â Â Â Â Â  Model_Version_ _= (string?)pr?.Model_Version ?? "n/a",

Â Â Â Â Â Â Â Â Â Â Â  Threshold_Used_ _= (decimal?)pr?.Threshold_Used ?? 0.35m,

Â Â Â Â Â Â Â Â Â Â Â  Notes = (string?)null

Â Â Â Â Â Â Â  });

  

Â Â Â Â Â Â Â  // 4) Excursion_Trend_Index (serie mensual simple)

Â Â Â Â Â Â Â  var trend = await QueryAsync(cn, @"

Â Â Â Â Â Â Â Â Â Â Â  SELECT DATEFROMPARTS(YEAR(DeliveredAt), MONTH(DeliveredAt), 1) AS ts,_

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  _CAST(SUM(CASE WHEN Temp_Excursion_True=1 THEN 1 ELSE 0 END)_100.0/NULLIF(COUNT(*),0) AS DECIMAL(18,4)) AS val

Â Â Â Â Â Â Â Â Â Â Â  FROM dbo.ShipmentsHistory

Â Â Â Â Â Â Â Â Â Â Â  WHERE DeliveredAt >= DATEADD(month, -12, @now)

Â Â Â Â Â Â Â Â Â Â Â  GROUP BY DATEFROMPARTS(YEAR(DeliveredAt), MONTH(DeliveredAt), 1)

Â Â Â Â Â Â Â Â Â Â Â  ORDER BY ts", new { now = utcNow });

  

Â Â Â Â Â Â Â  foreach (var row in trend)

Â Â Â Â Â Â Â  {

Â Â Â Â Â Â Â Â Â Â Â  await ExecAsync(cn, "dbo.usp_KPISeries_Upsert", new {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  KPI_Name_ _= "Excursion_Trend_Index",_

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  _Series_Timestamp = (DateTime)row.ts,

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Series_Value_ _= (decimal)row.val,_

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  _Breakdown_Dimension = (string?)null,

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Breakdown_Value_ _= (string?)null,_

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  _Model_Version = (string?)pr?.Model_Version ?? "n/a"

Â Â Â Â Â Â Â Â Â Â Â  });

Â Â Â Â Â Â Â  }

Â Â Â  }

  

Â Â Â  private static async Task<IEnumerable<dynamic>> QueryAsync(SqlConnection cn, string sql, object param)

Â Â Â  {

Â Â Â Â Â Â Â  using var cmd = new SqlCommand(sql, cn) { CommandType = CommandType.Text };

Â Â Â Â Â Â Â  foreach (var prop in param.GetType().GetProperties())

Â Â Â Â Â Â Â Â Â Â Â  cmd.Parameters.AddWithValue("@" + prop.Name, prop.GetValue(param) ?? DBNull.Value);

Â Â Â Â Â Â Â  using var rd = await cmd.ExecuteReaderAsync();

Â Â Â Â Â Â Â  var list = new List<dynamic>();

Â Â Â Â Â Â Â  while (await rd.ReadAsync())

Â Â Â Â Â Â Â  {

Â Â Â Â Â Â Â Â Â Â Â  var dict = Enumerable.Range(0, rd.FieldCount).ToDictionary(rd.GetName, rd.GetValue);

Â Â Â Â Â Â Â Â Â Â Â  list.Add(dict);

Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  return list;

Â Â Â  }

  

Â Â Â  private static async Task<dynamic?> QuerySingleAsync(SqlConnection cn, string sql, object param)

Â Â Â  {

Â Â Â Â Â Â Â  var rows = await QueryAsync(cn, sql, param);

Â Â Â Â Â Â Â  return rows.FirstOrDefault();

Â Â Â  }

  

Â Â Â  private static async Task<T> QuerySingleScalarAsync<T>(SqlConnection cn, string sql, object param)

Â Â Â  {

Â Â Â Â Â Â Â  using var cmd = new SqlCommand(sql, cn) { CommandType = CommandType.Text };

Â Â Â Â Â Â Â  foreach (var prop in param.GetType().GetProperties())

Â Â Â Â Â Â Â Â Â Â Â  cmd.Parameters.AddWithValue("@" + prop.Name, prop.GetValue(param) ?? DBNull.Value);

Â Â Â Â Â Â Â  var obj = await cmd.ExecuteScalarAsync();

Â Â Â Â Â Â Â  return (obj == null || obj == DBNull.Value) ?Â Â Â Â Â Â Â  return (obj == null || obj == DBNull.Value) ? default! : (T)Convert.ChangeType(obj, typeof(T));

Â Â Â  }

  

Â Â Â  private static async Task ExecAsync(SqlConnection cn, string sp, object param)

Â Â Â  {

Â Â Â Â Â Â Â  using var cmd = new SqlCommand(sp, cn) { CommandType = CommandType.StoredProcedure };

Â Â Â Â Â Â Â  foreach (var prop in param.GetType().GetProperties())

Â Â Â Â Â Â Â Â Â Â Â  cmd.Parameters.AddWithValue("@" + prop.Name, prop.GetValue(param) ?? DBNull.Value);

Â Â Â Â Â Â Â  await cmd.ExecuteNonQueryAsync();

Â Â Â  }

> **Notas**:
> 
> - Ajusta nombres de tablas/columnas reales (`Predictions`, `ShipmentsHistory`, flags, fechas).
> - Este _job_ se corre cada noche (o cada hora) y deja KPIs listos en `KPI_Facts`/`KPI_Series`.

---

## ğŸŒ API REST unificada (ASP.NET Core Minimal)

### `GET /api/kpis`

Devuelve un KPI agregado (por periodo + desglose).\ **Query**: `kpiName`, `from`, `to`, `granularity`, `breakdownDimension`, `breakdownValue`.

// Program.cs (fragmento)

app.MapGet("/api/kpis", async (

Â Â Â  [FromQuery] string kpiName,

Â Â Â  [FromQuery] DateTime from,

Â Â Â  [FromQuery] DateTime to,

Â Â Â  [FromQuery] string granularity,

Â Â Â  [FromQuery] string? breakdownDimension,

Â Â Â  [FromQuery] string? breakdownValue,

Â Â Â  IConfiguration cfg) =>

{

Â Â Â  var conn = cfg.GetConnectionString("Default");

Â Â Â  using var cn = new SqlConnection(conn);

Â Â Â  await cn.OpenAsync();

  

Â Â Â  var sql = @"

SELECT TOP 1 KPI_Name, KPI_DisplayName, KPI_Value, KPI_Unit,

Â Â Â Â Â Â  Period_Start, Period_End, Granularity,

Â Â Â Â Â Â  Breakdown_Dimension, Breakdown_Value,

Â Â Â Â Â Â  Model_Version, Threshold_Used, Last_Updated, Notes_

_FROM dbo.KPI_Facts

WHERE KPI_Name = @k_

Â  _AND Period_Start >= @from AND Period_End <= @to_

Â  _AND Granularity = @g_

Â  _AND (@bd IS NULL OR Breakdown_Dimension = @bd)

Â  AND (@bv IS NULL OR Breakdown_Value = @bv)_

_ORDER BY Last_Updated DESC";

  

Â Â Â  using var cmd = new SqlCommand(sql, cn);

Â Â Â  cmd.Parameters.AddWithValue("@k", kpiName);

Â Â Â  cmd.Parameters.AddWithValue("@from", from);

Â Â Â  cmd.Parameters.AddWithValue("@to", to);

Â Â Â  cmd.Parameters.AddWithValue("@g", granularity);

Â Â Â  cmd.Parameters.AddWithValue("@bd", (object?)breakdownDimension ?? DBNull.Value);

Â Â Â  cmd.Parameters.AddWithValue("@bv", (object?)breakdownValue ?? DBNull.Value);

  

Â Â Â  using var rd = await cmd.ExecuteReaderAsync();

Â Â Â  if (!await rd.ReadAsync()) return Results.NotFound();

  

Â Â Â  var resp = new {

Â Â Â Â Â Â Â  kpi = rd["KPIÂ Â Â Â Â Â Â  kpi = rd["KPI_Name__"],_

Â Â Â Â Â Â Â  _displayName = rd["KPI_DisplayName"],

Â Â Â Â Â Â Â  value = rd["KPI_Value__"],_

Â Â Â Â Â Â Â  _unit = rd["KPI_Unit"],

Â Â Â Â Â Â Â  periodStart = rd["Period_Start__"],_

Â Â Â Â Â Â Â  _periodEnd = rd["Period_End"],

Â Â Â Â Â Â Â  granularity = rd["Granularity"],

Â Â Â Â Â Â Â  breakdownDimension = rd["Breakdown_Dimension__"] is DBNull ? null : rd["Breakdown_Dimension"],

Â Â Â Â Â Â Â  breakdownValue = rd["Breakdown_Value__"] is DBNull ? null : rd["Breakdown_Value"],

Â Â Â Â Â Â Â  modelVersion = rd["Model_Version__"],_

Â Â Â Â Â Â Â  _thresholdUsed = rd["Threshold_Used"],

Â Â Â Â Â Â Â  lastUpdated = rd["Last_Updated"],

Â Â Â Â Â Â Â  notes = rd["Notes"] is DBNull ? null : rd["Notes"]

Â Â Â  };

Â Â Â  return Results.Ok(resp);

### `GET /api/kpi-series`

Devuelve puntos de serie temporal para un KPI.\ **Query**: `kpiName`, `from`, `to`, `breakdownDimension`, `breakdownValue`.

app.MapGet("/api/kpi-series", async (

Â Â Â  [FromQuery] string kpiName,

Â Â Â  [FromQuery] DateTime from,

Â Â Â  [FromQuery] DateTime to,

Â Â Â  [FromQuery] string? breakdownDimension,

Â Â Â  [FromQuery] string? breakdownValue,

Â Â Â  IConfiguration cfg) =>

{

Â Â Â  var conn = cfg.GetConnectionString("Default");

Â Â Â  using var cn = new SqlConnection(conn);

Â Â Â  await cn.OpenAsync();

  

Â Â Â  var sql = @"

SELECT Series_Timestamp, Series_Value, Model_Version, Last_Updated

FROM dbo.KPI_Series_

_WHERE KPI_Name = @k

Â  AND Series_Timestamp BETWEEN @from AND @to_

Â  _AND (@bd IS NULL OR Breakdown_Dimension = @bd)

Â  AND (@bv IS NULL OR Breakdown_Value = @bv)_

_ORDER BY Series_Timestamp";

  

Â Â Â  using var cmd = new SqlCommand(sql, cn);

Â Â Â  cmd.Parameters.AddWithValue("@k", kpiName);

Â Â Â  cmd.Parameters.AddWithValue("@from", from);

Â Â Â  cmd.Parameters.AddWithValue("@to", to);

Â Â Â  cmd.Parameters.AddWithValue("@bd", (object?)breakdownDimension ?? DBNull.Value);

Â Â Â  cmd.Parameters.AddWithValue("@bv", (object?)breakdownValue ?? DBNull.Value);

  

Â Â Â  using var rd = await cmd.ExecuteReaderAsync();

Â Â Â  var points = new List<object>();

Â Â Â  string? modelVersion = null;

Â Â Â  DateTime? lastUpdated = null;

  

Â Â Â  while (await rd.ReadAsync())

Â Â Â  {

Â Â Â Â Â Â Â  points.Add(new {

Â Â Â Â Â Â Â Â Â Â Â  ts = (DateTime)rd["Series_Timestamp"__],_

Â Â Â Â Â Â Â Â Â Â Â  _value = (decimal)rd["Series_Value"]

Â Â Â Â Â Â Â  });

Â Â Â Â Â Â Â  modelVersion ??= rd["Model_Version"__] as string;_

Â Â Â Â Â Â Â  _lastUpdated ??= (DateTime)rd["Last_Updated"];

Â Â Â  }

  

Â Â Â  return Results.Ok(new {

Â Â Â Â Â Â Â  kpi = kpiName,

Â Â Â Â Â Â Â  points,

Â Â Â Â Â Â Â  modelVersion,

Â Â Â Â Â Â Â  lastUpdated

Â Â Â  });

> **Seguridad & Gobernanza**: aÃ±ade autenticaciÃ³n/autorizaciÃ³n (JWT/AAD), validaciÃ³n fuerte de parÃ¡metros y _rate limiting_ si el dashboard hace consultas frecuentes.

---

## ğŸ–¼ï¸ Diapositiva preparada

- **Ruta**: `artifacts/KPI_Standard_Slide.png`
- **Uso**: puedes insertarla tal cual en tu presentaciÃ³n.
- Si la quieres en **SVG** o como **.pptx** con estilos de tu empresa, dÃ­melo y la genero.

---

## âœ… Siguientes pasos (rÃ¡pidos)

1. **Ejecuta los DDL** en tu SQL Server (`artifacts/sql/...`).
2. **Crea los stored procedures** de _upsert_.
3. **Corre el Worker .NET** (o un job SQL) que calcule y cargue los KPIs a diario.
4. **Levanta la API REST** con los `GET /api/kpis` y `/api/kpi-series`.
5. **Conecta cualquier dashboard** a la **misma fuente** (SQL o JSON).

Â¿Quieres que te entregue:

- Un **repo ZIP** con la **soluciÃ³n .NET** (Worker + API + scripts SQL + README)?
- La **diapositiva** tambiÃ©n en **SVG** y un **PowerPoint** con esta y otra slide de â€œVentajas competitivasâ€?
