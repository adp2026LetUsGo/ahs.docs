##### Agrega soporte para autenticación en la API e Incluye un dashboard de ejemplo en Power BI


¡Listo, Armando! Ya agregué **autenticación en la API** (API Key + base para JWT) y un **dashboard de ejemplo en Power BI** con consultas en M tanto contra la API protegida como contra SQL Server. Te dejo el ZIP actualizado para descargar:

[Repo ZIP actualizado: AHS.TempExcursions](blob:https://www.microsoft365.com/3f7b2874-dce4-4194-8206-3f20bed39fad)

---

## Qué añadí

### 1) Autenticación en la API (API Key + JWT básico)

- **API Key**:
    - Header requerido: `X-API-Key: <tu_clave>`.
    - Configurable en `src/Api/appsettings.json` → `"Auth": { "ApiKey": "CHANGE_ME_STRONG_KEY" }`.
    - Implementado con un **AuthenticationHandler** (`ApiKeyAuthHandler`) y una **política** `ApiAuth` que acepta autenticar por **API Key** o **JWT**.
- **JWT (base)**:
    - Incluido paquete `Microsoft.AspNetCore.Authentication.JwtBearer`.
    - Preparado para que definas `Issuer/Audience/SigningKey` si quieres validación estricta (por ahora es mínimo para que puedas integrarlo luego con tu IdP o gateway).
- **Endpoints**:
    - `GET /health` → público (sin auth).
    - Grupo `/api` (`/api/kpis`, `/api/kpi-series`) → **RequireAuthorization("ApiAuth")** (exige API Key o JWT).

> Archivos modificados:
> 
> - `src/Api/Program.cs` (handler de API Key, uso de AuthN/AuthZ y grupo protegido).
> - `src/Api/Api.csproj` (referencia a `Microsoft.AspNetCore.Authentication.JwtBearer`).
> - `src/Api/appsettings.json` (clave API y connection string).

### 2) Dashboard de ejemplo en Power BI

- Carpeta: `dashboards/powerbi/`
    - `README.md`: pasos para conectarte a la **API** (con API Key) y a **SQL Server**.
    - `Queries/ApiKpiSeries.m`: consulta Power Query (M) que llama `GET /api/kpi-series` con header `X-API-Key` y mapea el JSON a tabla.
    - `Queries/SqlKpiDaily.m`: consulta Power Query (M) que lee `te.KPI_Daily` desde SQL Server.

> Visuales sugeridos en el **README**:
> 
> - **Líneas**: `BucketStartUtc` vs `AvgTempC` (API).
> - **Cards**: `ReadingCount`, `ExcursionsAbove/Below`, `MinutesAbove/Below` (SQL).
> - **Columnas**: `AvgTempC` y `MaxTempC` por `KpiDate` (SQL).

---

## Cómo probarlo (rápido)

1. **Configura la clave de API**

// src/Api/appsettings.json

{

  "ConnectionStrings": {

    "Sql": "Server=localhost;Database=TempExcursions;Trusted_Connection=True;TrustServerCertificate=True"_

  _},_

  _"Auth": {_

    _"ApiKey": "PON_AQUI_T    "ApiKey": "PON_AQUI_TU_CLAVE_LARGA_Y_SEGURA"

  }

2. **Levanta la API**

cd src/Api

dotnet run

- Prueba `GET /health` (sin auth).
- Prueba `GET /api/kpis?sensorId=1&date=2025-12-15` **con** header `X-API-Key: <tu_clave>`.

1. **Power BI (API protegida)**

- Power BI Desktop → **Obtener datos** → **Consulta en blanco** → **Editor avanzado**.
- Pega el contenido de `dashboards/powerbi/Queries/ApiKpiSeries.m`.
- Cambia `ApiBaseUrl`, `SensorId`, fechas y **ApiKey**.
- Visualiza líneas con `BucketStartUtc` vs `AvgTempC`.

1. **Power BI (SQL)**

- Power BI Desktop → **SQL Server** → servidor `localhost`, base `TempExcursions`.
- O pega `dashboards/powerbi/Queries/SqlKpiDaily.m` en un Query en blanco.
- Añade **cards** y **gráficos** según el README.

---

## Notas de seguridad y despliegue

- **API Key**: usa una **clave larga**, rota periódicamente y considera almacenarla en **User Secrets** o variables de entorno (`DOTNET_...`) en producción.
- **JWT**: cuando definas el emisor/audiencia y la clave de firma, activa validación estricta (Issuer/Audience/SigningKey) y HTTPS.
- **CORS**: si expones la API a páginas web, configura CORS según tus orígenes.
- **Datos**: si el volumen crece, consideramos **índices por fecha** o **particionamiento** en `KPI_Daily`.

---

## Estructura actualizada

```
AHS.TempExcursions/
├── README.md
├── artifacts/sql/
│   ├── 001_ddl.sql
│   └── 002_stored_procedures.sql
├── src/
│   ├── Worker/
│   │   ├── Program.cs
│   │   └── Worker.csproj
│   └── Api/
│       ├── Program.cs           # AHORA con Auth (API Key + JWT)
│       ├── Api.csproj           # + JwtBearer
│       └── appsettings.json     # Auth.ApiKey
└── dashboards/
    └── powerbi/
        ├── README.md
        └── Queries/
            ├── ApiKpiSeries.m   # API + X-API-Key
            └── SqlKpiDaily.m    # SQL Server
```

---

## ¿Quieres que añada…?

- Un **tema (.json)** para Power BI (colores y tipografías consistentes).
- **Medidas DAX** prediseñadas (ej. `ExcursionRate = (ExcursionsAbove + ExcursionsBelow) / ReadingCount`).
- **Docker Compose** (SQL Server + API + Worker + refresh) para probar de punta a punta.
- Validación JWT estricta con **Issuer/Audience/SigningKey** y ejemplo de **token** de prueba.

Si te sirve, lo integro y te entrego un ZIP actualizado en el siguiente turno.