##### DiseÃ±a la tabla KPI estÃ¡ndar

Â¡Perfecto, Armando! AquÃ­ tienes el **diseÃ±o de una tabla KPI estÃ¡ndar** pensado para que **todas** tus herramientas (Power BI, Tableau, Grafana, Superset, Dashboard .NET + Blazor, etc.) consuman **la misma fuente** sin reprogramar nada.

---

## ðŸŽ¯ Objetivo

- **Un solo punto de verdad** para los KPIs.
- Formato **simple y extensible** (soporta periodos, filtros y â€œbreakdownsâ€ por ruta, carrier, embalaje, etc.).
- Compatible con **SQL** (consulta directa) y **API REST** (JSON).

---

## ðŸ—‚ï¸ Esquema mÃ­nimo recomendado

### Tabla: `KPI_Facts` (estÃ¡ndar de salida)

|Columna|Tipo (SQL Server)|DescripciÃ³n|
|---|---|---|
|`KPI_Name`|`nvarchar(100)`|Nombre corto del KPI (p. ej., `Risk_Percentage`, `Model_Recall`).|
|`KPI_DisplayName`|`nvarchar(200)`|Nombre amigable para UI (p. ej., â€œPorcentaje de embarques en riesgoâ€).|
|`KPI_Value`|`decimal(18,4)`|Valor del KPI en el periodo indicado.|
|`KPI_Unit`|`nvarchar(50)`|Unidad (p. ej., `%`, `EUR`, `count`).|
|`Period_Start`|`datetime2`|Inicio del periodo (p. ej., 2025-12-01).|
|`Period_End`|`datetime2`|Fin del periodo (p. ej., 2025-12-31).|
|`Granularity`|`nvarchar(20)`|`daily` \| `weekly` \| `monthly` \| `rolling_30d`.|
|`Breakdown_Dimension`|`nvarchar(50)`|DimensiÃ³n de desglose (p. ej., `Route_ID`, `Carrier`, `Packaging_Type`).|
|`Breakdown_Value`|`nvarchar(200)`|Valor especÃ­fico del desglose (p. ej., `MIL->ROM`, `CarrierX`).|
|`Model_Version`|`nvarchar(100)`|VersiÃ³n del modelo que alimenta el KPI (trazabilidad).|
|`Threshold_Used`|`decimal(9,4)`|Umbral de decisiÃ³n usado para banderas/alertas en el periodo.|
|`Last_Updated`|`datetime2`|Fecha/hora de actualizaciÃ³n del registro.|
|`Notes`|`nvarchar(500)`|Notas opcionales (metodologÃ­a, incidencias, etc.).|

> **Por quÃ© asÃ­:**
> 
> - `Breakdown_Dimension` + `Breakdown_Value` permiten **segmentar** KPIs (por ruta, carrier, embalaje) **sin crear tablas distintas**.
> - `Period_Start/End` + `Granularity` soporta tanto acumulados mensuales como ventanas rodantes (30 dÃ­as).
> - `Model_Version` y `Threshold_Used` garantizan **auditorÃ­a** y reproducibilidad.

---

## ðŸ“Š KPIs que vas a cargar (ejemplos)

1. **Risk_Percentage** _(% de embarques en riesgo)_
2. **Model_Recall** _(Recall del modelo)_
3. **Model_Precision** _(PrecisiÃ³n del modelo)_
4. **Cost_Avoided** _(Costo evitado)_
5. **Mitigation_Cost** _(Costo de mitigaciÃ³n)_
6. **Active_Alerts** _(Alertas activas)_
7. **Excursion_Trend_Index** _(Ãndice/serie para tendencia histÃ³rica)_

> Si una mÃ©trica es una **serie** (p. ej., tendencia), puedes:
> 
> - Guardar **puntos agregados** por mes/dÃ­a como filas separadas, o
> - Usar una tabla adicional `KPI_Series` (ver mÃ¡s abajo).

---

## âž• Tabla opcional para series: `KPI_Series`

|Columna|Tipo|DescripciÃ³n|
|---|---|---|
|`KPI_Name`|`nvarchar(100)`|Nombre del KPI (debe existir en `KPI_Facts`).|
|`Series_Timestamp`|`datetime2`|Timestamp del punto de la serie.|
|`Series_Value`|`decimal(18,4)`|Valor del punto.|
|`Breakdown_Dimension`|`nvarchar(50)`|DimensiÃ³n (igual idea que en `KPI_Facts`).|
|`Breakdown_Value`|`nvarchar(200)`|Valor del desglose.|
|`Model_Version`|`nvarchar(100)`|VersiÃ³n del modelo.|
|`Last_Updated`|`datetime2`|ActualizaciÃ³n.|

> **CuÃ¡ndo usarla:** Para grÃ¡ficos de lÃ­nea (p. ej., **tendencia de excursiones** por semana/mes).

---

## ðŸ› ï¸ DDL (SQL Server) â€” creaciÃ³n de tablas

> _No poner cÃ³digo dentro de tablas._ Incluyo el DDL en **bloques de cÃ³digo**:

CREATE TABLE dbo.KPI_Facts_ _(_

Â Â Â  _KPI_NameÂ Â Â Â Â Â Â Â Â Â Â  nvarchar(100)Â  NOT NULL,

Â Â Â  KPI_DisplayName_Â Â Â Â  _nvarchar(200)Â  NOT NULL,_

Â Â Â  _KPI_ValueÂ Â Â Â Â Â Â Â Â Â  decimal(18,4)Â  NOT NULL,

Â Â Â  KPI_Unit_Â Â Â Â Â Â Â Â Â Â Â  _nvarchar(50)Â Â  NOT NULL,_

Â Â Â  _Period_StartÂ Â Â Â Â Â Â  datetime2Â Â Â Â Â  NOT NULL,

Â Â Â  Period_End_Â Â Â Â Â Â Â Â Â  _datetime2Â Â Â Â Â  NOT NULL,_

Â Â Â  _GranularityÂ Â Â Â Â Â Â Â  nvarchar(20)Â Â  NOT NULL,_

Â Â Â  _Breakdown_Dimension nvarchar(50)Â Â  NULL,

Â Â Â  Breakdown_Value_Â Â Â Â  _nvarchar(200)Â  NULL,_

Â Â Â  _Model_VersionÂ Â Â Â Â Â  nvarchar(100)Â  NULL,

Â Â Â  Threshold_Used_Â Â Â Â Â  _decimal(9,4)Â Â  NULL,_

Â Â Â  _Last_UpdatedÂ Â Â Â Â Â Â  datetime2Â Â Â Â Â  NOT NULL DEFAULT sysdatetime(),

Â Â Â  NotesÂ Â Â Â Â Â Â Â Â Â Â Â Â Â  nvarchar(500)Â  NULL

);

CREATE INDEX IX_KPI_Facts_Period_ _ON dbo.KPI_Facts (Period_Start__, Period_End);

CREATE INDEX IX_KPI_Facts_NameBreakdown_ _ON dbo.KPI_Facts (KPI_Name__, Breakdown_Dimension, Breakdown_Value__);_

_CREATE TABLE dbo.KPI_Series (

Â Â Â  KPI_Name_Â Â Â Â Â Â Â Â Â Â Â  _nvarchar(100)Â  NOT NULL,_

Â Â Â  _Series_TimestampÂ Â Â  datetime2Â Â Â Â Â  NOT NULL,

Â Â Â  Series_Value_Â Â Â Â Â Â Â  _decimal(18,4)Â  NOT NULL,_

Â Â Â  _Breakdown_Dimension nvarchar(50)Â Â  NULL,

Â Â Â  Breakdown_Value_Â Â Â Â  _nvarchar(200)Â  NULL,_

Â Â Â  _Model_VersionÂ Â Â Â Â Â  nvarchar(100)Â  NULL,

Â Â Â  Last_Updated_Â Â Â Â Â Â Â  _datetime2Â Â Â Â Â  NOT NULL DEFAULT sysdatetime()_

_);_

_CREATE INDEX IX_KPI_Series_KPI ON dbo.KPI_Series_ _(KPI_Name, Series_Timestamp);

---

## ðŸ”Œ API REST unificada (salida estÃ¡ndar)

Para que **cualquier dashboard** consuma tus KPIs sin tocar cÃ¡lculos:

### Endpoint: `GET /api/kpis`

**Query params**: `kpiName`, `from`, `to`, `granularity`, `breakdownDimension`, `breakdownValue`

**Response (JSON):**

{

Â  "kpi": "Risk_Percentage"__,_

Â  _"displayName": "Porcentaje de embarques en riesgo",_

Â  _"unit": "%",_

Â  _"periodStart": "2025-12-01",_

Â  _"periodEnd": "2025-12-31",_

Â  _"granularity": "monthly",_

Â  _"breakdownDimension": "Route_ID",

Â  "breakdownValue": "MIL->ROM",

Â  "value": 12.5,

Â  "modelVersion": "temperature-risk-v1-2025-12-01",

Â  "thresholdUsed": 0.35,

Â  "lastUpdated": "2025-12-10T09:30:00Z",

Â  "notes": "Includes cost-based threshold and calibrated probabilities"

}

### Endpoint para series: `GET /api/kpi-series`

**Query params**: `kpiName`, `breakdownDimension`, `breakdownValue`, `from`, `to`

**Response:**

{

Â  "kpi": "Excursion_Trend_Index",

Â  "points": [

Â Â Â  { "ts": "2025-06-01", "value": 8.2 },

Â Â Â  { "ts": "2025-07-01", "value": 7.9 },

Â Â Â  { "ts": "2025-08-01", "value": 9.1 }

Â  ],

Â  "modelVersion": "temperature-risk-v1-2025-12-01",

Â  "lastUpdated": "2025-12-10T09:30:00Z"

}

> **Ventaja:** Power BI, Tableau, Grafana y tu dashboard en Blazor pueden leer **la misma salida JSON** o conectarse directamente a `KPI_Facts`/`KPI_Series` en SQL.

---

## ðŸ§© ETL / CÃ¡lculo (propuesta)

- **Job diario** (p. ej., 02:00):
    
    1. Lee predicciones guardadas (tabla `Predictions`).
    2. Calcula KPIs del dÃ­a/mes (Risk_Percentage, Recall/Precision rolling 30d, Cost_Avoided, Mitigation_Cost, Active_Alerts).
    3. Escribe/actualiza `KPI_Facts`.
    4. Actualiza `KPI_Series` para tendencias.
- **Versionado y trazabilidad**: rellena `Model_Version` y `Threshold_Used` desde tus artefactos (`threshold.txt` + versiÃ³n del modelo ONNX).
    

---

## ðŸ“Œ Convenciones de nombres (sugerencias)

- **KPI_Name** (camel case, sin espacios):\ `Risk_Percentage`, `Model_Recall`, `Model_Precision`, `Cost_Avoided`, `Mitigation_Cost`, `Active_Alerts`, `Excursion_Trend_Index`.
    
- **KPI_Unit**:\ `%`, `count`, `EUR` (o la moneda que uses), `index`.
    
- **Granularity**:\ `daily`, `weekly`, `monthly`, `rolling_30d`.
    

---

## âœ… Beneficios

- **Un solo formato**: cero re-trabajo por herramienta.
- **Extensible**: agrega nuevos KPIs sin cambiar esquema bÃ¡sico.
- **Auditables**: `Model_Version` y `Threshold_Used` facilitan auditorÃ­as y comparativas.
- **Multiplataforma**: SQL directo o JSON por API â†’ **todas las herramientas consumen lo mismo**.

---

## Â¿Siguiente paso?

Puedo:

- Generar **el script de carga ETL** (C# o SQL) que calcula y llena `KPI_Facts` y `KPI_Series`.
- Crear el **endpoint `/api/kpis`** y `/api/kpi-series` en tu **ASP.NET Core**.
- Preparar una **diapositiva** con este esquema (PNG/SVG) para tu gerente.
